<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timesheet Admin Portal - Task Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 min-h-screen">
    <!-- Header -->
    <header class="bg-white dark:bg-slate-800 shadow-lg border-b border-slate-200 dark:border-slate-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-cogs text-3xl text-primary-600 dark:text-primary-400"></i>
                    </div>
                    <div class="ml-4">
                        <h1 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Timesheet Admin Portal</h1>
                        <p class="text-sm text-slate-600 dark:text-slate-400">Task Management & Timesheet Overview</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="themeToggle" class="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:inline"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Password Protection Modal -->
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-lock text-2xl text-red-600 dark:text-red-400"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-2">Admin Access Required</h3>
                <p class="text-slate-600 dark:text-slate-400">Enter the admin password to continue</p>
            </div>
            <form id="passwordForm" class="space-y-4">
                <div>
                    <label for="adminPassword" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
                        Admin Password *
                    </label>
                    <input type="password" id="adminPassword" name="adminPassword" required
                        class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 placeholder-slate-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                </div>
                <button type="submit" id="passwordBtn"
                    class="w-full bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800">
                    <i class="fas fa-unlock mr-2"></i>Access Admin Panel
                </button>
            </form>
            <div id="passwordError" class="mt-4 text-center text-red-600 dark:text-red-400 text-sm hidden">
                Incorrect password. Please try again.
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Task Management Section -->
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-primary-600 to-primary-700 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-tasks text-xl text-white"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <h2 class="text-xl font-bold text-white">Task Management</h2>
                            <p class="text-primary-100">Create and manage timesheet tasks</p>
                        </div>
                    </div>
                    <button id="addTaskBtn" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add Task
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div id="tasksList" class="space-y-4">
                    <!-- Tasks will be populated here -->
                </div>
            </div>
        </div>

        <!-- Timesheet Overview Section -->
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
            <div class="bg-gradient-to-r from-primary-600 to-primary-700 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-calendar-alt text-xl text-white"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <h2 class="text-xl font-bold text-white">Timesheet Overview</h2>
                            <p class="text-primary-100">View submitted timesheets</p>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                        <button id="exportWeekBtn" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-colors text-sm whitespace-nowrap">
                            <i class="fas fa-file-excel mr-2"></i>Export Week to Excel
                        </button>
                        <input type="date" id="weekDatePicker" class="px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50 text-sm" title="Select any date in the week to export">
                        <button id="importExcelBtn" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-colors text-sm whitespace-nowrap">
                            <i class="fas fa-file-excel mr-2"></i>Import Timesheet Excel
                        </button>
                        <input type="file" id="importExcelFile" accept=".xlsx,.xls" class="hidden">
                        <input type="text" id="searchEmployee" placeholder="Search by employee name..." class="px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50 text-sm">
                        <input type="date" id="filterDate" class="px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50 text-sm">
                        <button id="refreshBtn" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-4 sm:p-6">
                <!-- Mobile Card View -->
                <div id="mobileTimesheetsView" class="space-y-4 sm:hidden">
                    <!-- Mobile cards will be populated here -->
                </div>
                
                <!-- Desktop Table View -->
                <div class="hidden sm:block overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50 dark:bg-slate-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Employee</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Total Timesheets</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Latest Submission</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="timesheetsTable" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Task Modal -->
    <div id="addTaskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-tasks text-2xl text-primary-600 dark:text-primary-400"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-2">Add New Task</h3>
                <p class="text-slate-600 dark:text-slate-400">Create a new task for timesheet tracking</p>
            </div>
            <form id="addTaskForm" class="space-y-4">
                <div>
                    <label for="taskName" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
                        Task Name *
                    </label>
                    <input type="text" id="taskName" name="taskName" required
                        class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 placeholder-slate-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                </div>
                <div>
                    <label for="taskDescription" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
                        Description
                    </label>
                    <textarea id="taskDescription" name="taskDescription" rows="3"
                        class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 placeholder-slate-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all resize-none"></textarea>
                </div>
                <div class="flex justify-center space-x-3 pt-4">
                    <button type="button" id="cancelAddTask" class="px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Add Task
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Employee Timesheets Modal -->
    <div id="employeeTimesheetsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-user text-2xl text-primary-600 dark:text-primary-400"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-2">Employee Timesheets</h3>
                <p id="employeeTimesheetsName" class="text-lg font-medium text-slate-700 dark:text-slate-300 mb-1"></p>
            </div>
            <div id="employeeTimesheetsList" class="space-y-3">
                <!-- Employee timesheets will be populated here -->
            </div>
            <div class="flex justify-center pt-6">
                <button id="closeEmployeeModal" class="px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- View Timesheet Modal -->
    <div id="viewTimesheetModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-calendar-alt text-2xl text-primary-600 dark:text-primary-400"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-2">Timesheet Details</h3>
                <p id="timesheetEmployeeName" class="text-lg font-medium text-slate-700 dark:text-slate-300 mb-1"></p>
                <p id="timesheetDate" class="text-slate-600 dark:text-slate-400"></p>
            </div>
            <div id="timesheetDetails" class="space-y-4">
                <!-- Timesheet details will be populated here -->
            </div>
            <div class="flex flex-col items-center space-y-3 pt-6">
                <button id="exportPdfBtn" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors">
                    <i class="fas fa-file-pdf mr-2"></i>Export PDF
                </button>
                <button id="exportExcelBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                    <i class="fas fa-file-excel mr-2"></i>Export Excel
                </button>
                <button id="closeViewModal" class="px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Task Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600 dark:text-red-400"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-2">Delete Task</h3>
                <p class="text-slate-600 dark:text-slate-400 mb-6">Are you sure you want to delete this task? This action cannot be undone.</p>
                <div class="flex justify-center space-x-3">
                    <button id="cancelDelete" class="px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                        Cancel
                    </button>
                    <button id="confirmDelete" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Timesheet Confirmation Modal -->
    <div id="deleteTimesheetModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600 dark:text-red-400"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-2">Delete Timesheet</h3>
                <p class="text-slate-600 dark:text-slate-400 mb-6">Are you sure you want to delete this timesheet? This action cannot be undone.</p>
                <div class="flex justify-center space-x-3">
                    <button id="cancelDeleteTimesheet" class="px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                        Cancel
                    </button>
                    <button id="confirmDeleteTimesheet" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase (modular SDK via ESM) -->
    <script type="module">
        // ----- Firebase Setup -----
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import {
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, query, where, getDocs, getDoc, onSnapshot, orderBy
        } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBESXzUMBCBEjCcXPbDf6dtOIvPOaeHRro",
            authDomain: "custimesheet.firebaseapp.com",
            projectId: "custimesheet",
            storageBucket: "custimesheet.firebasestorage.app",
            messagingSenderId: "685823796911",
            appId: "1:685823796911:web:428460f86ee09a3aed165a",
            measurementId: "G-CJ2JKW60XJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tasksRef = collection(db, "timesheet_tasks");
        const timesheetsRef = collection(db, "timesheets");

        // ----- Theme Toggle -----
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;

        const currentTheme = localStorage.getItem('theme') || 'light';
        html.classList.toggle('dark', currentTheme === 'dark');

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const newTheme = html.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
        });

        // ----- Element References -----
        const passwordModal = document.getElementById('passwordModal');
        const passwordForm = document.getElementById('passwordForm');
        const passwordBtn = document.getElementById('passwordBtn');
        const passwordError = document.getElementById('passwordError');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const addTaskModal = document.getElementById('addTaskModal');
        const addTaskForm = document.getElementById('addTaskForm');
        const cancelAddTask = document.getElementById('cancelAddTask');
        const tasksList = document.getElementById('tasksList');
        const timesheetsTable = document.getElementById('timesheetsTable');
        const mobileTimesheetsView = document.getElementById('mobileTimesheetsView');
        const searchEmployee = document.getElementById('searchEmployee');
        const filterDate = document.getElementById('filterDate');
        const refreshBtn = document.getElementById('refreshBtn');
        const exportWeekBtn = document.getElementById('exportWeekBtn');
        const weekDatePicker = document.getElementById('weekDatePicker');
        const importExcelBtn = document.getElementById('importExcelBtn');
        const importExcelFile = document.getElementById('importExcelFile');
        const employeeTimesheetsModal = document.getElementById('employeeTimesheetsModal');
        const employeeTimesheetsList = document.getElementById('employeeTimesheetsList');
        const employeeTimesheetsName = document.getElementById('employeeTimesheetsName');
        const closeEmployeeModal = document.getElementById('closeEmployeeModal');
        const viewTimesheetModal = document.getElementById('viewTimesheetModal');
        const closeViewModal = document.getElementById('closeViewModal');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const deleteModal = document.getElementById('deleteModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');
        const deleteTimesheetModal = document.getElementById('deleteTimesheetModal');
        const cancelDeleteTimesheet = document.getElementById('cancelDeleteTimesheet');
        const confirmDeleteTimesheet = document.getElementById('confirmDeleteTimesheet');

        // ----- Global Variables -----
        let tasks = [];
        let timesheets = [];
        let taskToDelete = null;
        let timesheetToDelete = null;
        let isAuthenticated = false;

        // ----- Helper Functions -----
        function formatDate(date) {
            if (!date) return '';
            
            let dateObj;
            if (date.toDate && typeof date.toDate === 'function') {
                // Firebase timestamp
                dateObj = date.toDate();
            } else if (date instanceof Date) {
                dateObj = date;
            } else if (typeof date === 'string') {
                // Handle different date string formats
                if (date.includes('-')) {
                    // yyyy-mm-dd format
                    dateObj = new Date(date);
                } else {
                    dateObj = new Date(date);
                }
            } else {
                dateObj = new Date(date);
            }
            
            // Format as mm/dd/yyyy
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const year = dateObj.getFullYear();
            return `${month}/${day}/${year}`;
        }

        // ----- Password Protection -----
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function showMainContent() {
            passwordModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function showPasswordModal() {
            passwordModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // Check if already authenticated
        if (getCookie('adminAuth') === 'true') {
            isAuthenticated = true;
            showMainContent();
        } else {
            showPasswordModal();
        }

        // Password form submission
        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(passwordForm);
            const password = formData.get('adminPassword');

            passwordBtn.disabled = true;
            passwordBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verifying...';

            if (password === 'cus') {
                isAuthenticated = true;
                setCookie('adminAuth', 'true', 1); // Valid for 1 day
                showMainContent();
                passwordForm.reset();
                passwordError.classList.add('hidden');
                initializeAdminApp(); // Load data after authentication
            } else {
                passwordError.classList.remove('hidden');
                passwordForm.reset();
            }

            passwordBtn.disabled = false;
            passwordBtn.innerHTML = '<i class="fas fa-unlock mr-2"></i>Access Admin Panel';
        });

        // ----- Load Tasks -----
        function loadTasks() {
            onSnapshot(tasksRef, (snapshot) => {
                tasks = [];
                tasksList.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    const task = { id: doc.id, ...doc.data() };
                    tasks.push(task);
                    
                    const taskElement = document.createElement('div');
                    taskElement.className = 'bg-slate-50 dark:bg-slate-700 rounded-lg p-4 border border-slate-200 dark:border-slate-600';
                    taskElement.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-tasks text-primary-600 dark:text-primary-400"></i>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">${task.name}</h3>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">${task.description || 'No description'}</p>
                                    <div class="flex items-center mt-1">
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${task.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">
                                            ${task.status}
                                        </span>
                                        <span class="ml-2 text-xs text-slate-500 dark:text-slate-400">
                                            Created: ${formatDate(task.createdAt)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="deleteTask('${task.id}')" class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button onclick="toggleTaskStatus('${task.id}', '${task.status}')" class="text-sm px-3 py-1 rounded-lg ${task.status === 'active' ? 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200 dark:bg-yellow-900 dark:text-yellow-200 dark:hover:bg-yellow-800' : 'bg-green-100 text-green-800 hover:bg-green-200 dark:bg-green-900 dark:text-green-200 dark:hover:bg-green-800'} transition-colors">
                                    ${task.status === 'active' ? 'Deactivate' : 'Activate'}
                                </button>
                            </div>
                        </div>
                    `;
                    tasksList.appendChild(taskElement);
                });
            });
        }

        // ----- Load Timesheets -----
        async function loadTimesheets() {
            try {
                const q = query(timesheetsRef, orderBy('submittedAt', 'desc'));
                const querySnapshot = await getDocs(q);
                
                timesheets = [];
                timesheetsTable.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const timesheet = { id: doc.id, ...doc.data() };
                    timesheets.push(timesheet);
                });

                // Group timesheets by employee
                const timesheetsByEmployee = {};
                timesheets.forEach(timesheet => {
                    const employee = timesheet.submittedBy || 'Unknown Employee';
                    if (!timesheetsByEmployee[employee]) {
                        timesheetsByEmployee[employee] = [];
                    }
                    timesheetsByEmployee[employee].push(timesheet);
                });

                // Sort employees by name
                const employeeNames = Object.keys(timesheetsByEmployee).sort((a, b) => 
                    a.toLowerCase().localeCompare(b.toLowerCase())
                );
                
                // Populate table with one row per employee
                employeeNames.forEach(employeeName => {
                    const employeeTimesheets = timesheetsByEmployee[employeeName];
                    const latestTimesheet = employeeTimesheets[0]; // Already sorted by submittedAt desc
                    const latestSubmittedDate = latestTimesheet.submittedAt?.toDate() || new Date(latestTimesheet.submittedAt);
                    const totalCount = employeeTimesheets.length;
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-slate-100">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user text-primary-600 dark:text-primary-400 text-sm"></i>
                                    </div>
                                </div>
                                <div class="ml-3">
                                    <div class="text-sm font-medium text-slate-900 dark:text-slate-100">
                                        ${employeeName}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                ${totalCount} timesheet${totalCount !== 1 ? 's' : ''}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                            <div>${formatDate(latestSubmittedDate)}</div>
                            <div class="text-xs">${latestSubmittedDate.toLocaleTimeString()}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center space-x-2">
                                <button onclick="viewEmployeeTimesheets('${employeeName}')" class="text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300 p-2 rounded-lg hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-colors" title="View Timesheets">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    timesheetsTable.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading timesheets:', error);
            }
        }

        // ----- Add Task -----
        addTaskBtn.addEventListener('click', () => {
            addTaskModal.classList.remove('hidden');
        });

        cancelAddTask.addEventListener('click', () => {
            addTaskModal.classList.add('hidden');
            addTaskForm.reset();
        });

        addTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(addTaskForm);
            const taskData = {
                name: formData.get('taskName'),
                description: formData.get('taskDescription'),
                status: 'active',
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(tasksRef, taskData);
                addTaskModal.classList.add('hidden');
                addTaskForm.reset();
            } catch (error) {
                console.error('Error adding task:', error);
                alert('Failed to add task. Please try again.');
            }
        });

        // ----- Toggle Task Status -----
        window.toggleTaskStatus = async function(taskId, currentStatus) {
            try {
                const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                await updateDoc(doc(db, 'timesheet_tasks', taskId), { status: newStatus });
            } catch (error) {
                console.error('Error updating task status:', error);
                alert('Failed to update task status. Please try again.');
            }
        };

        // ----- Delete Task -----
        window.deleteTask = function(taskId) {
            taskToDelete = taskId;
            deleteModal.classList.remove('hidden');
        };

        cancelDelete.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            taskToDelete = null;
        });

        confirmDelete.addEventListener('click', async () => {
            if (taskToDelete) {
                try {
                    await deleteDoc(doc(db, 'timesheet_tasks', taskToDelete));
                    deleteModal.classList.add('hidden');
                    taskToDelete = null;
                } catch (error) {
                    console.error('Error deleting task:', error);
                    alert('Failed to delete task. Please try again.');
                }
            }
        });

        // ----- View Employee Timesheets -----
        window.viewEmployeeTimesheets = function(employeeName) {
            const employeeTimesheets = timesheets.filter(ts => (ts.submittedBy || 'Unknown Employee') === employeeName);
            
            if (employeeTimesheets.length === 0) {
                alert('No timesheets found for this employee.');
                return;
            }

            // Group timesheets by week (Sunday to Saturday)
            const timesheetsByWeek = {};
            employeeTimesheets.forEach(timesheet => {
                const weekKey = getWeekKey(timesheet.date);
                if (!timesheetsByWeek[weekKey]) {
                    timesheetsByWeek[weekKey] = [];
                }
                timesheetsByWeek[weekKey].push(timesheet);
            });

            // Sort weeks by date (most recent first)
            const weekKeys = Object.keys(timesheetsByWeek).sort((a, b) => {
                return new Date(b) - new Date(a);
            });

            employeeTimesheetsName.textContent = employeeName;
            employeeTimesheetsList.innerHTML = '';

            weekKeys.forEach(weekKey => {
                const weekTimesheets = timesheetsByWeek[weekKey];
                // Parse the weekKey (YYYY-MM-DD format)
                const [year, month, day] = weekKey.split('-').map(Number);
                const sunday = new Date(year, month - 1, day);
                const saturday = new Date(sunday);
                saturday.setDate(sunday.getDate() + 6);
                
                // Sort timesheets within the week by date
                weekTimesheets.sort((a, b) => {
                    return new Date(b.date) - new Date(a.date);
                });

                // Calculate total tasks for the week
                const totalTasks = weekTimesheets.reduce((sum, ts) => {
                    return sum + Object.values(ts.tasks || {}).flat().length;
                }, 0);

                // Get latest submission date
                const latestSubmission = weekTimesheets.reduce((latest, ts) => {
                    const submittedDate = ts.submittedAt?.toDate() || new Date(ts.submittedAt);
                    return submittedDate > latest ? submittedDate : latest;
                }, new Date(0));

                const card = document.createElement('div');
                card.className = 'bg-slate-50 dark:bg-slate-700 rounded-lg p-4 border border-slate-200 dark:border-slate-600';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-4">
                                <div>
                                    <p class="text-sm font-semibold text-slate-900 dark:text-slate-100">Week: ${formatDate(sunday)} - ${formatDate(saturday)}</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">${weekTimesheets.length} day${weekTimesheets.length !== 1 ? 's' : ''} submitted • Latest: ${formatDate(latestSubmission)} ${latestSubmission.toLocaleTimeString()}</p>
                                </div>
                                <div>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                        ${totalTasks} tasks
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <button onclick="viewWeekTimesheet('${weekKey}', '${employeeName}')" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg transition-colors">
                                <i class="fas fa-eye mr-2"></i>View
                            </button>
                            <button onclick="exportWeekTimesheetPdf('${weekKey}', '${employeeName}')" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors">
                                <i class="fas fa-file-pdf mr-2"></i>Export PDF
                            </button>
                            <button onclick="exportWeekTimesheetExcel('${weekKey}', '${employeeName}')" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors">
                                <i class="fas fa-file-excel mr-2"></i>Export Excel
                            </button>
                        </div>
                    </div>
                `;
                employeeTimesheetsList.appendChild(card);
            });

            employeeTimesheetsModal.classList.remove('hidden');
        };

        closeEmployeeModal.addEventListener('click', () => {
            employeeTimesheetsModal.classList.add('hidden');
        });

        // ----- View Timesheet -----
        window.viewTimesheet = async function(timesheetId) {
            try {
                const timesheet = timesheets.find(ts => ts.id === timesheetId);
                if (!timesheet) return;

                // Store current timesheet for PDF export
                currentTimesheetForPdf = timesheet;

                document.getElementById('timesheetEmployeeName').textContent = timesheet.submittedBy || 'Unknown Employee';
                document.getElementById('timesheetDate').textContent = `Submitted on ${formatDate(timesheet.date)}`;
                
                const detailsContainer = document.getElementById('timesheetDetails');
                detailsContainer.innerHTML = '';

                const timeSlots = [
                    { key: '7am-9am', label: '7:00 AM - 9:00 AM' },
                    { key: '9am-1130am', label: '9:00 AM - 11:30 AM' },
                    { key: '1130am-12pm', label: '11:30 AM - 12:00 PM' },
                    { key: '12pm-330pm', label: '12:00 PM - 3:30 PM' },
                    { key: '330pm-530pm', label: '3:30 PM - 5:30 PM' }
                ];

                timeSlots.forEach(slot => {
                    const tasks = timesheet.tasks?.[slot.key] || [];
                    if (tasks.length > 0) {
                        const slotDiv = document.createElement('div');
                        slotDiv.className = 'bg-slate-50 dark:bg-slate-700 rounded-lg p-4';
                        slotDiv.innerHTML = `
                            <h4 class="font-semibold text-slate-900 dark:text-slate-100 mb-2">${slot.label}</h4>
                            <ul class="space-y-1">
                                ${tasks.map(task => `<li class="text-sm text-slate-600 dark:text-slate-400">• ${task}</li>`).join('')}
                            </ul>
                        `;
                        detailsContainer.appendChild(slotDiv);
                    }
                });

                if (detailsContainer.children.length === 0) {
                    detailsContainer.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center py-8">No tasks recorded for this day.</p>';
                }

                viewTimesheetModal.classList.remove('hidden');
            } catch (error) {
                console.error('Error viewing timesheet:', error);
            }
        };

        closeViewModal.addEventListener('click', () => {
            viewTimesheetModal.classList.add('hidden');
        });

        // ----- Export PDF -----
        let currentTimesheetForPdf = null;

        exportPdfBtn.addEventListener('click', () => {
            if (currentTimesheetForPdf) {
                // Check if it's a week export
                if (currentTimesheetForPdf.weekTimesheets) {
                    exportWeekTimesheetToPdf(currentTimesheetForPdf.weekTimesheets, currentTimesheetForPdf.employeeName);
                } else {
                    exportTimesheetToPdf(currentTimesheetForPdf);
                }
            }
        });

        // ----- Export Excel -----
        exportExcelBtn.addEventListener('click', () => {
            if (currentTimesheetForPdf) {
                // Check if it's a week export
                if (currentTimesheetForPdf.weekTimesheets) {
                    exportWeekTimesheetToExcel(currentTimesheetForPdf.weekTimesheets, currentTimesheetForPdf.employeeName);
                } else {
                    exportTimesheetToExcel(currentTimesheetForPdf);
                }
            }
        });

        // ----- Export Week Timesheet PDF -----
        window.exportWeekTimesheetPdf = function(weekKey, employeeName) {
            const weekTimesheets = timesheets.filter(ts => 
                (ts.submittedBy || 'Unknown Employee') === employeeName && 
                getWeekKey(ts.date) === weekKey
            );
            
            if (weekTimesheets.length === 0) {
                alert('No timesheets found for this week.');
                return;
            }

            exportWeekTimesheetToPdf(weekTimesheets, employeeName);
        };

        // ----- Export Week Timesheet Excel -----
        window.exportWeekTimesheetExcel = function(weekKey, employeeName) {
            const weekTimesheets = timesheets.filter(ts => 
                (ts.submittedBy || 'Unknown Employee') === employeeName && 
                getWeekKey(ts.date) === weekKey
            );
            
            if (weekTimesheets.length === 0) {
                alert('No timesheets found for this week.');
                return;
            }

            exportWeekTimesheetToExcel(weekTimesheets, employeeName);
        };

        // ----- View Week Timesheet -----
        window.viewWeekTimesheet = function(weekKey, employeeName) {
            const weekTimesheets = timesheets.filter(ts => 
                (ts.submittedBy || 'Unknown Employee') === employeeName && 
                getWeekKey(ts.date) === weekKey
            );
            
            if (weekTimesheets.length === 0) {
                alert('No timesheets found for this week.');
                return;
            }

            // Sort by date
            weekTimesheets.sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });

            // Parse the weekKey (YYYY-MM-DD format)
            const [year, month, day] = weekKey.split('-').map(Number);
            const sunday = new Date(year, month - 1, day);
            const saturday = new Date(sunday);
            saturday.setDate(sunday.getDate() + 6);

            document.getElementById('timesheetEmployeeName').textContent = employeeName;
            document.getElementById('timesheetDate').textContent = `Week: ${formatDate(sunday)} - ${formatDate(saturday)}`;
            
            const detailsContainer = document.getElementById('timesheetDetails');
            detailsContainer.innerHTML = '';

            const timeSlots = [
                { key: '7am-9am', label: '7:00 AM - 9:00 AM' },
                { key: '9am-1130am', label: '9:00 AM - 11:30 AM' },
                { key: '1130am-12pm', label: '11:30 AM - 12:00 PM' },
                { key: '12pm-330pm', label: '12:00 PM - 3:30 PM' },
                { key: '330pm-530pm', label: '3:30 PM - 5:30 PM' }
            ];

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const weekDates = getWeekDates(weekKey);

            weekDates.forEach((date, dayIndex) => {
                const timesheet = weekTimesheets.find(ts => ts.date === date);
                // Parse the date string to avoid UTC timezone issues
                const [year, month, day] = date.split('-').map(Number);
                const dateObj = new Date(year, month - 1, day);
                // Get the actual day of the week for this date
                const actualDayOfWeek = dateObj.getDay();
                const dayName = dayNames[actualDayOfWeek];
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'bg-slate-50 dark:bg-slate-700 rounded-lg p-4 border border-slate-200 dark:border-slate-600';
                dayDiv.innerHTML = `
                    <h4 class="font-semibold text-slate-900 dark:text-slate-100 mb-3">${dayName} - ${formatDate(dateObj)}</h4>
                    ${timesheet ? `
                        <div class="space-y-2">
                            ${timeSlots.map(slot => {
                                const tasks = timesheet.tasks?.[slot.key] || [];
                                if (tasks.length > 0) {
                                    return `
                                        <div class="mb-2">
                                            <p class="text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">${slot.label}</p>
                                            <ul class="space-y-1">
                                                ${tasks.map(task => `<li class="text-sm text-slate-700 dark:text-slate-300">• ${task}</li>`).join('')}
                                            </ul>
                                        </div>
                                    `;
                                }
                                return '';
                            }).join('')}
                        </div>
                    ` : '<p class="text-sm text-slate-500 dark:text-slate-400">No timesheet submitted for this day.</p>'}
                `;
                detailsContainer.appendChild(dayDiv);
            });

            // Store week timesheets for export
            currentTimesheetForPdf = { weekTimesheets, employeeName, weekKey };
            viewTimesheetModal.classList.remove('hidden');
        };

        // ----- Export Week Timesheet to PDF -----
        function exportWeekTimesheetToPdf(weekTimesheets, employeeName) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get the week key (Sunday date) from the first timesheet
            const weekKey = getWeekKey(weekTimesheets[0].date);
            // Parse the weekKey (YYYY-MM-DD format) to avoid UTC issues
            const [year, month, day] = weekKey.split('-').map(Number);
            const sunday = new Date(year, month - 1, day);
            const saturday = new Date(sunday);
            saturday.setDate(sunday.getDate() + 6);

            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Weekly Timesheet Report', 20, 30);
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Employee: ${employeeName}`, 20, 50);
            doc.text(`Week: ${formatDate(sunday)} - ${formatDate(saturday)}`, 20, 60);
            
            doc.setLineWidth(0.5);
            doc.line(20, 70, 190, 70);
            
            const timeSlots = [
                { key: '7am-9am', label: '7:00 AM - 9:00 AM' },
                { key: '9am-1130am', label: '9:00 AM - 11:30 AM' },
                { key: '1130am-12pm', label: '11:30 AM - 12:00 PM' },
                { key: '12pm-330pm', label: '12:00 PM - 3:30 PM' },
                { key: '330pm-530pm', label: '3:30 PM - 5:30 PM' }
            ];

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            // Use the weekKey (Sunday) to generate week dates, not the first timesheet date
            const weekDates = getWeekDates(weekKey);
            
            let yPosition = 85;
            
            weekDates.forEach((date, dayIndex) => {
                const timesheet = weekTimesheets.find(ts => ts.date === date);
                // Parse the date string to avoid UTC timezone issues
                const [year, month, day] = date.split('-').map(Number);
                const dateObj = new Date(year, month - 1, day);
                // Get the actual day of the week for this date
                const actualDayOfWeek = dateObj.getDay();
                const dayName = dayNames[actualDayOfWeek];
                
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`${dayName} - ${formatDate(dateObj)}`, 20, yPosition);
                yPosition += 10;
                
                if (timesheet) {
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    timeSlots.forEach(slot => {
                        const tasks = timesheet.tasks?.[slot.key] || [];
                        if (tasks.length > 0) {
                            if (yPosition > 270) {
                                doc.addPage();
                                yPosition = 20;
                            }
                            doc.setFont(undefined, 'bold');
                            doc.text(slot.label + ':', 25, yPosition);
                            yPosition += 7;
                            doc.setFont(undefined, 'normal');
                            tasks.forEach(task => {
                                if (yPosition > 270) {
                                    doc.addPage();
                                    yPosition = 20;
                                }
                                doc.text(`  • ${task}`, 30, yPosition);
                                yPosition += 7;
                            });
                        }
                    });
                } else {
                    doc.setFontSize(10);
                    doc.text('No timesheet submitted for this day.', 25, yPosition);
                    yPosition += 7;
                }
                
                yPosition += 5;
            });
            
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Page ${i} of ${pageCount}`, 20, 285);
                doc.text('Generated by Timesheet Admin Portal', 120, 285);
            }
            
            const safeEmployeeName = employeeName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
            const fileName = `timesheet_${safeEmployeeName}_week_${formatDateForFilename(sunday)}_to_${formatDateForFilename(saturday)}.pdf`;
            doc.save(fileName);
        }

        // ----- Export Week Timesheet to Excel -----
        function exportWeekTimesheetToExcel(weekTimesheets, employeeName) {
            const wb = XLSX.utils.book_new();
            const excelData = [];
            
            // Get the week key (Sunday date) from the first timesheet
            const weekKey = getWeekKey(weekTimesheets[0].date);
            // Parse the weekKey (YYYY-MM-DD format) to avoid UTC issues
            const [year, month, day] = weekKey.split('-').map(Number);
            const sunday = new Date(year, month - 1, day);
            const saturday = new Date(sunday);
            saturday.setDate(sunday.getDate() + 6);

            excelData.push(['Weekly Timesheet Report']);
            excelData.push([]);
            excelData.push(['Employee:', employeeName]);
            excelData.push(['Week:', `${formatDate(sunday)} - ${formatDate(saturday)}`]);
            excelData.push([]);

            const timeSlots = [
                { key: '7am-9am', label: '7:00 AM - 9:00 AM' },
                { key: '9am-1130am', label: '9:00 AM - 11:30 AM' },
                { key: '1130am-12pm', label: '11:30 AM - 12:00 PM' },
                { key: '12pm-330pm', label: '12:00 PM - 3:30 PM' },
                { key: '330pm-530pm', label: '3:30 PM - 5:30 PM' }
            ];

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            // Use the weekKey (Sunday) to generate week dates, not the first timesheet date
            const weekDates = getWeekDates(weekKey);

            const headerRow = ['Time Slot'];
            weekDates.forEach((date, index) => {
                // Parse the date string to avoid UTC timezone issues
                const [year, month, day] = date.split('-').map(Number);
                const dateObj = new Date(year, month - 1, day);
                // Get the actual day of the week for this date
                const actualDayOfWeek = dateObj.getDay();
                headerRow.push(`${dayNames[actualDayOfWeek]} (${formatDate(dateObj)})`);
            });
            excelData.push(headerRow);

            timeSlots.forEach(slot => {
                const row = [slot.label];
                weekDates.forEach(date => {
                    const timesheet = weekTimesheets.find(ts => ts.date === date);
                    const tasks = timesheet?.tasks?.[slot.key] || [];
                    if (tasks.length > 0) {
                        row.push(tasks.join(', '));
                    } else {
                        row.push('No tasks');
                    }
                });
                excelData.push(row);
            });

            const ws = XLSX.utils.aoa_to_sheet(excelData);

            const colWidths = [{ wch: 25 }];
            weekDates.forEach(() => colWidths.push({ wch: 30 }));
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, 'Weekly Timesheet');

            const safeEmployeeName = employeeName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
            const fileName = `timesheet_${safeEmployeeName}_week_${formatDateForFilename(sunday)}_to_${formatDateForFilename(saturday)}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
        }

        // ----- Export Timesheet PDF (from employee list) - kept for backward compatibility -----
        window.exportTimesheetPdf = function(timesheetId) {
            const timesheet = timesheets.find(ts => ts.id === timesheetId);
            if (timesheet) {
                exportTimesheetToPdf(timesheet);
            }
        };

        // ----- Export Timesheet Excel (from employee list) - kept for backward compatibility -----
        window.exportTimesheetExcel = function(timesheetId) {
            const timesheet = timesheets.find(ts => ts.id === timesheetId);
            if (timesheet) {
                exportTimesheetToExcel(timesheet);
            }
        };

        function exportTimesheetToPdf(timesheet) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set up the PDF
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Timesheet Report', 20, 30);
            
            // Employee and date info
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Employee: ${timesheet.submittedBy || 'Unknown'}`, 20, 50);
            doc.text(`Date: ${formatDate(timesheet.date)}`, 20, 60);
            doc.text(`Submitted: ${new Date(timesheet.submittedAt?.toDate() || timesheet.submittedAt).toLocaleString()}`, 20, 70);
            
            // Add a line separator
            doc.setLineWidth(0.5);
            doc.line(20, 80, 190, 80);
            
            // Time slots
            const timeSlots = [
                { key: '7am-9am', label: '7:00 AM - 9:00 AM' },
                { key: '9am-1130am', label: '9:00 AM - 11:30 AM' },
                { key: '1130am-12pm', label: '11:30 AM - 12:00 PM' },
                { key: '12pm-330pm', label: '12:00 PM - 3:30 PM' },
                { key: '330pm-530pm', label: '3:30 PM - 5:30 PM' }
            ];
            
            let yPosition = 95;
            let hasTasks = false;
            
            timeSlots.forEach(slot => {
                const tasks = timesheet.tasks?.[slot.key] || [];
                if (tasks.length > 0) {
                    hasTasks = true;
                    
                    // Check if we need a new page
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    // Time slot header
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(slot.label, 20, yPosition);
                    yPosition += 10;
                    
                    // Tasks
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    tasks.forEach(task => {
                        if (yPosition > 270) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        doc.text(`• ${task}`, 25, yPosition);
                        yPosition += 7;
                    });
                    
                    yPosition += 5; // Extra space between time slots
                }
            });
            
            if (!hasTasks) {
                doc.setFontSize(12);
                doc.text('No tasks recorded for this day.', 20, yPosition);
            }
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Page ${i} of ${pageCount}`, 20, 285);
                doc.text('Generated by Timesheet Admin Portal', 120, 285);
            }
            
            // Save the PDF
            const fileName = `timesheet_${timesheet.submittedBy?.replace(/\s+/g, '_') || 'employee'}_${formatDate(timesheet.date).replace(/\//g, '-')}.pdf`;
            doc.save(fileName);
        }

        function exportTimesheetToExcel(timesheet) {
            // Create a new workbook
            const wb = XLSX.utils.book_new();
            
            // Prepare data for Excel
            const excelData = [];
            
            // Header row
            excelData.push(['Timesheet Report']);
            excelData.push([]); // Empty row
            excelData.push(['Employee:', timesheet.submittedBy || 'Unknown']);
            excelData.push(['Date:', formatDate(timesheet.date)]);
            excelData.push(['Submitted:', new Date(timesheet.submittedAt?.toDate() || timesheet.submittedAt).toLocaleString()]);
            excelData.push([]); // Empty row
            
            // Column headers
            excelData.push(['Time Slot', 'Tasks']);
            
            // Time slots data
            const timeSlots = [
                { key: '7am-9am', label: '7:00 AM - 9:00 AM' },
                { key: '9am-1130am', label: '9:00 AM - 11:30 AM' },
                { key: '1130am-12pm', label: '11:30 AM - 12:00 PM' },
                { key: '12pm-330pm', label: '12:00 PM - 3:30 PM' },
                { key: '330pm-530pm', label: '3:30 PM - 5:30 PM' }
            ];
            
            let hasTasks = false;
            timeSlots.forEach(slot => {
                const tasks = timesheet.tasks?.[slot.key] || [];
                if (tasks.length > 0) {
                    hasTasks = true;
                    // First task in the time slot row
                    excelData.push([slot.label, tasks[0]]);
                    // Additional tasks in the same time slot (empty first column)
                    for (let i = 1; i < tasks.length; i++) {
                        excelData.push(['', tasks[i]]);
                    }
                } else {
                    // Show empty time slot
                    excelData.push([slot.label, 'No tasks']);
                }
            });
            
            if (!hasTasks) {
                excelData.push([]);
                excelData.push(['No tasks recorded for this day.']);
            }
            
            // Create worksheet from data
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 25 }, // Time Slot column
                { wch: 40 }  // Tasks column
            ];
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Timesheet');
            
            // Generate filename
            const fileName = `timesheet_${timesheet.submittedBy?.replace(/\s+/g, '_') || 'employee'}_${formatDate(timesheet.date).replace(/\//g, '-')}.xlsx`;
            
            // Save file
            XLSX.writeFile(wb, fileName);
        }

        // ----- Week Calculation Functions (Sunday to Saturday) -----
        function getSundayOfWeek(date) {
            // Handle both date strings (YYYY-MM-DD) and Date objects
            let d;
            if (typeof date === 'string') {
                // Parse YYYY-MM-DD format to avoid UTC timezone issues
                const [year, month, day] = date.split('-').map(Number);
                d = new Date(year, month - 1, day);
            } else {
                d = new Date(date);
            }
            
            // Ensure we're working with local date, not UTC
            const year = d.getFullYear();
            const month = d.getMonth();
            const dayOfMonth = d.getDate();
            const dayOfWeek = d.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            
            // For Sunday-Saturday weeks:
            // If it's Sunday (0), that's the start of the week
            // If it's Monday-Friday (1-5), go back to the previous Sunday
            // If it's Saturday (6), it belongs to the NEXT week (go forward to next Sunday)
            let daysToAdjust;
            if (dayOfWeek === 6) {
                // Saturday belongs to next week - go forward 1 day to next Sunday
                daysToAdjust = 1;
            } else {
                // Go back to previous Sunday
                daysToAdjust = -dayOfWeek;
            }
            
            const sundayDate = new Date(year, month, dayOfMonth + daysToAdjust);
            sundayDate.setHours(0, 0, 0, 0);
            return sundayDate;
        }

        function getWeekDates(date) {
            // Handle both date strings (YYYY-MM-DD) and Date objects
            let dateObj;
            if (typeof date === 'string') {
                // Parse YYYY-MM-DD format
                const [year, month, day] = date.split('-').map(Number);
                dateObj = new Date(year, month - 1, day);
            } else {
                dateObj = new Date(date);
            }
            const sunday = getSundayOfWeek(dateObj);
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const weekDate = new Date(sunday);
                weekDate.setDate(sunday.getDate() + i);
                const year = weekDate.getFullYear();
                const month = String(weekDate.getMonth() + 1).padStart(2, '0');
                const day = String(weekDate.getDate()).padStart(2, '0');
                weekDates.push(`${year}-${month}-${day}`);
            }
            return weekDates;
        }

        function getWeekKey(date) {
            const sunday = getSundayOfWeek(date);
            return `${sunday.getFullYear()}-${String(sunday.getMonth() + 1).padStart(2, '0')}-${String(sunday.getDate()).padStart(2, '0')}`;
        }

        function formatDateForFilename(date) {
            if (!date) return '';
            const dateObj = typeof date === 'string' ? new Date(date) : date;
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const year = dateObj.getFullYear();
            return `${month}-${day}-${year}`;
        }

        async function exportWeekToExcel(selectedDate) {
            if (!selectedDate) {
                alert('Please select a date to export the week.');
                return;
            }

            try {
                exportWeekBtn.disabled = true;
                exportWeekBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';

                // Get all dates in the week (Sunday to Saturday)
                const weekDates = getWeekDates(selectedDate);
                const sunday = new Date(weekDates[0]);
                const saturday = new Date(weekDates[6]);

                // Query all timesheets for the week
                const weekTimesheets = [];
                for (const date of weekDates) {
                    const q = query(timesheetsRef, where('date', '==', date));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((doc) => {
                        weekTimesheets.push({ id: doc.id, ...doc.data() });
                    });
                }

                if (weekTimesheets.length === 0) {
                    alert('No timesheets found for the selected week.');
                    exportWeekBtn.disabled = false;
                    exportWeekBtn.innerHTML = '<i class="fas fa-file-excel mr-2"></i>Export Week to Excel';
                    return;
                }

                // Group timesheets by worker
                const timesheetsByWorker = {};
                weekTimesheets.forEach(timesheet => {
                    const worker = timesheet.submittedBy || 'Unknown Employee';
                    if (!timesheetsByWorker[worker]) {
                        timesheetsByWorker[worker] = [];
                    }
                    timesheetsByWorker[worker].push(timesheet);
                });

                // Export each worker's timesheet to a separate file
                const workerNames = Object.keys(timesheetsByWorker);
                let exportedCount = 0;

                for (const workerName of workerNames) {
                    const workerTimesheets = timesheetsByWorker[workerName];
                    
                    // Create a new workbook for this worker
                    const wb = XLSX.utils.book_new();
                    const excelData = [];

                    // Header
                    excelData.push(['Weekly Timesheet Report']);
                    excelData.push([]);
                    excelData.push(['Employee:', workerName]);
                    excelData.push(['Week:', `${formatDate(sunday)} - ${formatDate(saturday)}`]);
                    excelData.push([]);

                    // Create a row for each day of the week
                    const timeSlots = [
                        { key: '7am-9am', label: '7:00 AM - 9:00 AM' },
                        { key: '9am-1130am', label: '9:00 AM - 11:30 AM' },
                        { key: '1130am-12pm', label: '11:30 AM - 12:00 PM' },
                        { key: '12pm-330pm', label: '12:00 PM - 3:30 PM' },
                        { key: '330pm-530pm', label: '3:30 PM - 5:30 PM' }
                    ];

                    // Create header row with days
                    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    const headerRow = ['Time Slot'];
                    weekDates.forEach((date, index) => {
                        const dateObj = new Date(date);
                        headerRow.push(`${dayNames[index]} (${formatDate(dateObj)})`);
                    });
                    excelData.push(headerRow);

                    // For each time slot, create a row with tasks for each day
                    timeSlots.forEach(slot => {
                        const row = [slot.label];
                        weekDates.forEach(date => {
                            const timesheet = workerTimesheets.find(ts => ts.date === date);
                            const tasks = timesheet?.tasks?.[slot.key] || [];
                            if (tasks.length > 0) {
                                row.push(tasks.join(', '));
                            } else {
                                row.push('No tasks');
                            }
                        });
                        excelData.push(row);
                    });

                    // Create worksheet from data
                    const ws = XLSX.utils.aoa_to_sheet(excelData);

                    // Set column widths
                    const colWidths = [{ wch: 25 }]; // Time Slot column
                    weekDates.forEach(() => colWidths.push({ wch: 30 })); // Day columns
                    ws['!cols'] = colWidths;

                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'Weekly Timesheet');

                    // Generate filename
                    const safeWorkerName = workerName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                    const fileName = `timesheet_${safeWorkerName}_week_${formatDateForFilename(sunday)}_to_${formatDateForFilename(saturday)}.xlsx`;

                    // Save file
                    XLSX.writeFile(wb, fileName);
                    exportedCount++;
                }

                alert(`Successfully exported ${exportedCount} file(s) for the week ${formatDate(sunday)} - ${formatDate(saturday)}.`);
            } catch (error) {
                console.error('Error exporting week to Excel:', error);
                alert('Failed to export week to Excel. Please try again.');
            } finally {
                exportWeekBtn.disabled = false;
                exportWeekBtn.innerHTML = '<i class="fas fa-file-excel mr-2"></i>Export Week to Excel';
            }
        }

        exportWeekBtn.addEventListener('click', () => {
            const selectedDate = weekDatePicker.value;
            if (!selectedDate) {
                alert('Please select a date in the week you want to export.');
                weekDatePicker.focus();
                return;
            }
            exportWeekToExcel(selectedDate);
        });

        // ----- Filter and Refresh -----
        function applyFilters() {
            const selectedDate = filterDate.value;
            const searchTerm = searchEmployee.value.toLowerCase();
            
            let filteredTimesheets = timesheets;
            
            // Filter by date
            if (selectedDate) {
                filteredTimesheets = filteredTimesheets.filter(ts => ts.date === selectedDate);
            }
            
            // Filter by employee name
            if (searchTerm) {
                filteredTimesheets = filteredTimesheets.filter(ts => 
                    (ts.submittedBy || 'Employee').toLowerCase().includes(searchTerm)
                );
            }
            
            updateTimesheetTable(filteredTimesheets);
        }

        searchEmployee.addEventListener('input', applyFilters);
        filterDate.addEventListener('change', applyFilters);

        refreshBtn.addEventListener('click', () => {
            loadTimesheets();
        });

        // ----- Import Excel Timesheet -----
        importExcelBtn.addEventListener('click', () => {
            importExcelFile.click();
        });

        importExcelFile.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                // Read the Excel file
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get the first worksheet
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                
                // Parse the Excel data
                // Expected format based on export: 
                // Row 0: "Timesheet Report"
                // Row 1: empty
                // Row 2: ["Employee:", "Name"]
                // Row 3: ["Date:", "date"]
                // Row 4: ["Submitted:", "timestamp"]
                // Row 5: empty
                // Row 6: ["Time Slot", "Tasks"]
                // Row 7+: [timeSlot, task1], ["", task2], etc.
                
                if (jsonData.length < 7) {
                    alert('Invalid Excel file format. Please use a timesheet exported from this system.');
                    importExcelFile.value = '';
                    return;
                }

                // Extract employee name
                const employeeRow = jsonData[2];
                const employeeName = employeeRow && employeeRow[1] ? employeeRow[1].toString().trim() : null;
                
                if (!employeeName) {
                    alert('Could not find employee name in the Excel file.');
                    importExcelFile.value = '';
                    return;
                }

                // Extract date
                const dateRow = jsonData[3];
                let dateStr = dateRow && dateRow[1] ? dateRow[1].toString().trim() : null;
                
                // Parse date (could be in various formats)
                let date = null;
                if (dateStr) {
                    // Try to parse different date formats
                    const dateObj = new Date(dateStr);
                    if (!isNaN(dateObj.getTime())) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const day = String(dateObj.getDate()).padStart(2, '0');
                        date = `${year}-${month}-${day}`;
                    } else {
                        // Try parsing formats like "12/11/2025" (mm/dd/yyyy) or "11-12-2025" (mm-dd-yyyy)
                        const dateMatch = dateStr.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
                        if (dateMatch) {
                            const [, month, day, year] = dateMatch;
                            date = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        }
                    }
                }
                
                if (!date) {
                    alert('Could not parse date from the Excel file. Please ensure the date is in a valid format.');
                    importExcelFile.value = '';
                    return;
                }

                // Extract tasks by time slot
                const tasks = {};
                const timeSlotMap = {
                    '7:00 AM - 9:00 AM': '7am-9am',
                    '9:00 AM - 11:30 AM': '9am-1130am',
                    '11:30 AM - 12:00 PM': '1130am-12pm',
                    '12:00 PM - 3:30 PM': '12pm-330pm',
                    '3:30 PM - 5:30 PM': '330pm-530pm'
                };

                // Start from row 7 (index 6) where the data starts
                let currentTimeSlot = null;
                for (let i = 6; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue;
                    
                    const timeSlotLabel = row[0] ? row[0].toString().trim() : '';
                    const task = row[1] ? row[1].toString().trim() : '';
                    
                    if (timeSlotLabel && timeSlotMap[timeSlotLabel]) {
                        // New time slot
                        currentTimeSlot = timeSlotMap[timeSlotLabel];
                        if (task && task !== 'No tasks') {
                            tasks[currentTimeSlot] = [task];
                        } else {
                            tasks[currentTimeSlot] = [];
                        }
                    } else if (currentTimeSlot && task && task !== 'No tasks') {
                        // Additional task for current time slot
                        if (!tasks[currentTimeSlot]) {
                            tasks[currentTimeSlot] = [];
                        }
                        tasks[currentTimeSlot].push(task);
                    }
                }

                // Ensure all time slots exist
                Object.values(timeSlotMap).forEach(slot => {
                    if (!tasks[slot]) {
                        tasks[slot] = [];
                    }
                });

                // Ensure lunch break is in 1130am-12pm slot
                if (!tasks['1130am-12pm'].includes('Lunch Break')) {
                    tasks['1130am-12pm'].push('Lunch Break');
                }

                // Check if timesheet already exists for this date and employee
                const q = query(
                    timesheetsRef,
                    where('date', '==', date),
                    where('submittedBy', '==', employeeName)
                );
                const querySnapshot = await getDocs(q);

                const timesheetData = {
                    date: date,
                    tasks: tasks,
                    submittedAt: serverTimestamp(),
                    submittedBy: employeeName
                };

                if (!querySnapshot.empty) {
                    // Update existing timesheet
                    const existingDoc = querySnapshot.docs[0];
                    await updateDoc(doc(db, 'timesheets', existingDoc.id), timesheetData);
                    alert(`Timesheet for ${employeeName} on ${date} has been updated successfully!`);
                } else {
                    // Create new timesheet
                    await addDoc(timesheetsRef, timesheetData);
                    alert(`Timesheet for ${employeeName} on ${date} has been imported successfully!`);
                }

                // Reload timesheets
                await loadTimesheets();
                
                // Reset file input
                importExcelFile.value = '';

            } catch (error) {
                console.error('Error importing Excel file:', error);
                alert('Failed to import Excel file. Please ensure it is a valid timesheet file exported from this system.');
                importExcelFile.value = '';
            }
        });

        // ----- Update Timesheet Table -----
        function updateTimesheetTable(timesheetsToShow) {
            timesheetsTable.innerHTML = '';
            mobileTimesheetsView.innerHTML = '';
            
            // Group timesheets by employee
            const timesheetsByEmployee = {};
            timesheetsToShow.forEach(timesheet => {
                const employee = timesheet.submittedBy || 'Unknown Employee';
                if (!timesheetsByEmployee[employee]) {
                    timesheetsByEmployee[employee] = [];
                }
                timesheetsByEmployee[employee].push(timesheet);
            });

            // Sort employees by name
            const employeeNames = Object.keys(timesheetsByEmployee).sort((a, b) => 
                a.toLowerCase().localeCompare(b.toLowerCase())
            );
            
            employeeNames.forEach(employeeName => {
                const employeeTimesheets = timesheetsByEmployee[employeeName];
                const latestTimesheet = employeeTimesheets[0];
                const latestSubmittedDate = latestTimesheet.submittedAt?.toDate() || new Date(latestTimesheet.submittedAt);
                const totalCount = employeeTimesheets.length;
                
                // Desktop table row
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-slate-100">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-primary-600 dark:text-primary-400 text-sm"></i>
                                </div>
                            </div>
                            <div class="ml-3">
                                <div class="text-sm font-medium text-slate-900 dark:text-slate-100">
                                    ${employeeName}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                            ${totalCount} timesheet${totalCount !== 1 ? 's' : ''}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                        <div>${formatDate(latestSubmittedDate)}</div>
                        <div class="text-xs">${latestSubmittedDate.toLocaleTimeString()}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center space-x-2">
                            <button onclick="viewEmployeeTimesheets('${employeeName}')" class="text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300 p-2 rounded-lg hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-colors" title="View Timesheets">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                timesheetsTable.appendChild(row);
                
                // Mobile card
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4 shadow-sm';
                
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-user text-primary-600 dark:text-primary-400"></i>
                            </div>
                            <div>
                                <h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100">
                                    ${employeeName}
                                </h3>
                                <p class="text-xs text-slate-500 dark:text-slate-400">${totalCount} timesheet${totalCount !== 1 ? 's' : ''}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="viewEmployeeTimesheets('${employeeName}')" class="text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300 p-2 rounded-lg hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-colors" title="View Timesheets">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="text-right">
                            <p class="text-xs text-slate-500 dark:text-slate-400">Latest Submission</p>
                            <p class="text-xs font-medium text-slate-900 dark:text-slate-100">
                                ${formatDate(latestSubmittedDate)}
                            </p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">
                                ${latestSubmittedDate.toLocaleTimeString()}
                            </p>
                        </div>
                    </div>
                `;
                
                mobileTimesheetsView.appendChild(card);
            });
        }

        // ----- Delete Timesheet -----
        window.deleteTimesheet = function(timesheetId) {
            timesheetToDelete = timesheetId;
            deleteTimesheetModal.classList.remove('hidden');
        };

        cancelDeleteTimesheet.addEventListener('click', () => {
            deleteTimesheetModal.classList.add('hidden');
            timesheetToDelete = null;
        });

        confirmDeleteTimesheet.addEventListener('click', async () => {
            if (timesheetToDelete) {
                try {
                    await deleteDoc(doc(db, 'timesheets', timesheetToDelete));
                    deleteTimesheetModal.classList.add('hidden');
                    timesheetToDelete = null;
                    // Reload timesheets to update the table
                    await loadTimesheets();
                } catch (error) {
                    console.error('Error deleting timesheet:', error);
                    alert('Failed to delete timesheet. Please try again.');
                }
            }
        });

        // ----- Close Modals on Outside Click -----
        [addTaskModal, viewTimesheetModal, employeeTimesheetsModal, deleteModal, deleteTimesheetModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        });

        // ----- Initialize -----
        function initializeAdminApp() {
            if (isAuthenticated) {
                loadTasks();
                loadTimesheets();
            }
        }

        // Initialize when authenticated
        if (isAuthenticated) {
            initializeAdminApp();
        }

        // ----- Keyboard Shortcuts -----
        document.addEventListener('keydown', (e) => {
            // Ctrl+Shift to go back to client page
            if (e.ctrlKey && e.shiftKey) {
                e.preventDefault();
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>
